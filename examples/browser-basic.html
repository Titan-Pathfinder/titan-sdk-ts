<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Titan SDK - Browser Example</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .quote {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        .provider {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin: 2px;
        }
        .output-amount {
            font-weight: bold;
            color: #28a745;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸš€ Titan SDK Browser Example</h1>
        <p>This example shows how to use the Titan SDK in a browser environment to get real-time swap quotes.</p>
        
        <div id="status" class="status info">
            Ready to connect. Click "Start Quote Stream" to begin.
        </div>
        
        <button id="startBtn" onclick="startQuoteStream()">Start Quote Stream</button>
        <button id="stopBtn" onclick="stopQuoteStream()" disabled>Stop Stream</button>
        
        <div id="quotes"></div>
    </div>

    <script type="module">
        import { V1Client, types } from 'titan-sdk/browser';
        
        // For browser, we need to use a different base58 library or implement base58 decoding
        // Using a simple base58 implementation for demo purposes
        const base58Alphabet = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
        
        function base58Decode(str) {
            const bytes = [0];
            for (let i = 0; i < str.length; i++) {
                const char = str[i];
                const charIndex = base58Alphabet.indexOf(char);
                if (charIndex === -1) throw new Error('Invalid base58 character');
                
                for (let j = 0; j < bytes.length; j++) {
                    bytes[j] *= 58;
                }
                bytes[0] += charIndex;
                
                let carry = 0;
                for (let j = 0; j < bytes.length; j++) {
                    bytes[j] += carry;
                    carry = bytes[j] >> 8;
                    bytes[j] &= 0xff;
                }
                while (carry) {
                    bytes.push(carry & 0xff);
                    carry >>= 8;
                }
            }
            
            // Remove leading zeros
            while (bytes.length > 1 && bytes[bytes.length - 1] === 0) {
                bytes.pop();
            }
            
            return new Uint8Array(bytes.reverse());
        }
        
        let client = null;
        let currentStream = null;
        
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function addQuote(quote, quoteNumber) {
            const quotesEl = document.getElementById('quotes');
            const quoteEl = document.createElement('div');
            quoteEl.className = 'quote';
            
            const providers = Object.keys(quote.quotes);
            const firstProvider = providers[0];
            const firstQuote = firstProvider ? quote.quotes[firstProvider] : null;
            const outputAmount = firstQuote ? (firstQuote.outAmount / 1e9).toFixed(6) : 'N/A';
            
            quoteEl.innerHTML = `
                <h3>Quote #${quoteNumber} (ID: ${quote.id})</h3>
                <p><strong>Output Amount:</strong> <span class="output-amount">${outputAmount} SOL</span></p>
                <p><strong>Providers:</strong> ${providers.map(p => `<span class="provider">${p}</span>`).join('')}</p>
                <p><strong>Timestamp:</strong> ${new Date().toLocaleTimeString()}</p>
            `;
            
            quotesEl.appendChild(quoteEl);
        }
        
        async function startQuoteStream() {
            try {
                updateStatus('Connecting to Titan API...', 'info');
                
                // Connect to the Titan API
                const WS_URL = "wss://fra.api.titan-sol.tech/api/v1/ws?auth=eyJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE3NTk3ODEyMDYsImV4cCI6MTc1OTc4MjEwNiwic3ViIjoiZ2VuZXJpY19mcm9udGVuZF91c2VyIiwiYXVkIjoiYXBpLnRpdGFuLmFnIiwiaXNzIjoiaHR0cHM6Ly9qd3QtYXV0aC13b3JrZXItZGV2LmRlbGljYXRlLXNpbGVuY2UtMTY3Ny53b3JrZXJzLmRldi8iLCJodHRwczovL2FwaS50aXRhbi5hZy91cGtfYjU4IjoiRnRFZnRhUkhnUTdBZjJLQnlZYWdhZXhtMk1OdTJtaHRmdjNiZVNWamtRblcifQ.tMIVOeN5DAr1oWtXH2UauO49GEOJ2EyadNakcYoSbb4";
                client = await V1Client.connect(WS_URL);
                updateStatus('Connected to Titan API', 'success');
                
                // Get server information
                const info = await client.getInfo();
                console.log('Server info:', info);
                
                // Create swap parameters
                const swapParams = {
                    swap: {
                        inputMint: base58Decode("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"), // USDC
                        outputMint: base58Decode("So11111111111111111111111111111111111111112"), // wSOL
                        amount: 1_000_000, // 1 USDC (6 decimals)
                        swapMode: types.common.SwapMode.ExactIn,
                        slippageBps: 50 // 0.5% slippage
                    },
                    transaction: {
                        userPublicKey: base58Decode("FtEftaRHgQ7Af2KByYagaexm2MNu2mhtfv3beSVjkQnW") // Replace with actual user pubkey
                    },
                    update: {
                        intervalMs: 2000, // Update every 2 seconds
                        num_quotes: 5 // Get 5 quotes total
                    }
                };
                
                // Start the quote stream
                const { stream } = await client.newSwapQuoteStream(swapParams);
                currentStream = stream;
                
                updateStatus('Starting quote stream...', 'info');
                document.getElementById('quotes').innerHTML = ''; // Clear previous quotes
                
                // Update button states
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                
                // Read quotes from the stream
                let quoteCount = 0;
                for await (const quote of stream) {
                    quoteCount++;
                    addQuote(quote, quoteCount);
                    
                    // Stop after 5 quotes
                    if (quoteCount >= 5) {
                        break;
                    }
                }
                
                updateStatus(`Stream completed. Received ${quoteCount} quotes.`, 'success');
                
            } catch (error) {
                console.error('Error:', error);
                updateStatus(`Error: ${error.message}`, 'error');
            } finally {
                // Update button states
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                currentStream = null;
            }
        }
        
        async function stopQuoteStream() {
            if (currentStream) {
                try {
                    // Cancel the stream
                    await currentStream.cancel();
                    updateStatus('Stream stopped by user', 'info');
                } catch (error) {
                    console.error('Error stopping stream:', error);
                }
            }
            
            // Update button states
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            currentStream = null;
        }
        
        // Make functions available globally for onclick handlers
        window.startQuoteStream = startQuoteStream;
        window.stopQuoteStream = stopQuoteStream;
    </script>
</body>
</html>
